{
	"name": "Posicao Estoque Tasy",
	"properties": {
		"activities": [
			{
				"name": "Posicao Estoque Tasy HTML",
				"type": "Copy",
				"dependsOn": [
					{
						"activity": "Posicao Estoque Tasy Sadalla",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "OracleSource",
						"oracleReaderQuery": "WITH AUX AS(\n\nselect\t\n    M.NR_ATENDIMENTO,\n    m.nr_movimento_estoque,\n\tm.cd_estabelecimento,\n\tm.cd_local_estoque,\n\tm.dt_movimento_estoque,\n\tm.cd_operacao_estoque,\n\to.ds_operacao,\n\tm.cd_acao,\n\tm.cd_material_estoque,\n\tm.dt_mesano_referencia,\n\tm.dt_processo,\n\tm.cd_unidade_medida_estoque,\n\tm.cd_setor_atendimento,\n\tm.ie_origem_documento,\n\tm.nr_documento,\n\tm.nr_sequencia_item_docto,\n\tm.cd_fornecedor,\n\tm.cd_local_estoque_destino,\n\tm.cd_centro_custo,\n\tm.cd_conta_contabil,\n\tm.qt_movimento,\n\tm.cd_unidade_med_mov,\n\tm.nm_usuario,\n\tm.ds_observacao,\n\te.cd_grupo_material,\n\te.ds_grupo_material,\n\te.cd_subgrupo_material,\n\te.ds_subgrupo_material,\n\te.cd_classe_material,\n\te.ds_classe_material,\n\te.ds_material,\n\tm.nr_seq_tab_orig,\n\tfast_ops.obter_convenio_atendimento(m.nr_atendimento) cd_convenio,\n\tsubstr(fast_ops.obter_nome_convenio(fast_ops.obter_convenio_atendimento(m.nr_atendimento)),1,80) ds_convenio,\n\t'M' ie_periodo,\n\tdecode(\tm.cd_acao,\n\t\t2,\tm.qt_estoque * -1,\n\t\t\tm.qt_estoque) qt_estoque,\n\tdecode(\tm.cd_acao,\n\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t'N', (0))),\n\t\t1, \tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t                 'A', (v.vl_movimento),\n\t\t\t                 'D', (v.vl_movimento * -1),\n\t\t\t                 'N', (0)))) vl_estoque,\n\tdecode(m.cd_acao,\n\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t'N', (0))),\n\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t'N', (0)))) vl_movimento,\n\tdecode(o.ie_consumo,\n\t\t'A',\tdecode(m.cd_acao,\n\t\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t\t'N', (0))),\n\t\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t\t'N', (0)))),\n\t\t'D',\tdecode(m.cd_acao,\n\t\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t\t'N', (0))),\n\t\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t\t'N', (0)))) *-1,\n\t0) vl_consumo,\n\tdecode(o.ie_consumo,\n\t\t'A',\tdecode(\tm.cd_acao,\n\t\t\t1,\tsum(qt_estoque),\n\t\t\t\tsum((qt_estoque * -1))),\n\t \t'D',\tdecode(\tm.cd_acao,\n\t\t\t1,\tsum(qt_estoque * -1),\n\t\t\t\tsum(qt_estoque)),\n\t\t0) qt_consumo,\n\tm.cd_material\nfrom fast_ops.tipo_valor t,\n\tfast_ops.operacao_estoque o,\n\tfast_ops.estrutura_material_v e,\n\tfast_ops.movimento_estoque m,\n\tfast_ops.movimento_estoque_valor v\nwhere\tm.nr_movimento_estoque\t= v.nr_movimento_estoque (+)\nand\tv.cd_tipo_valor\t\t= t.cd_tipo_valor(+)\nand\tm.cd_operacao_estoque\t= o.cd_operacao_estoque (+)\nand\tm.cd_material_estoque\t= e.cd_material\nand\tm.dt_processo is not null\ngroup by\n\tm.cd_estabelecimento,\n\tm.dt_mesano_referencia,\n\tm.dt_processo,\n\tm.cd_local_estoque,\n\tm.nr_movimento_estoque,\n\tm.dt_movimento_estoque,\n\tm.cd_operacao_estoque,\n\to.ds_operacao,\n\tm.cd_acao,\n\tm.cd_material_estoque,\n\tm.cd_unidade_medida_estoque,\n\tm.cd_setor_atendimento,\n\tm.ie_origem_documento,\n\tm.nr_documento,\n\tm.nr_sequencia_item_docto,\n\tm.cd_fornecedor,\n\tm.cd_local_estoque_destino,\n\tm.cd_centro_custo,\n\tm.cd_conta_contabil,\n\tm.qt_movimento,\n\tm.cd_unidade_med_mov,\n\tm.nm_usuario,\n\tdecode(m.cd_acao, 2, m.qt_estoque * -1, m.qt_estoque),\n\tm.ds_observacao,\n\te.cd_grupo_material,\n\te.ds_grupo_material,\n\te.cd_subgrupo_material,\n\te.ds_subgrupo_material,\n\te.cd_classe_material,\n\te.ds_classe_material,\n\te.ds_material,\n\tm.nr_seq_tab_orig,\n\t'M',\n\to.ie_consumo,\n\tm.nr_atendimento,\n\tm.cd_material\n)\n\n\nSELECT \n    1   AS ID_SYS\n    ,TO_CHAR(A.DT_PROCESSO,'YYYY-MM-DD') AS DATA_PROCESSO   \n    ,A.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,A.CD_ESTABELECIMENTO\n    ,ESTB.nm_fantasia_estab                      AS DS_ESTABELECIMENTO\n    ,A.CD_MATERIAL\n    ,A.DS_MATERIAL                               AS DS_MATERIAL\n    ,A.CD_CLASSE_MATERIAL\n    ,A.DS_CLASSE_MATERIAL                        AS DS_CLASSE_MATERIAL\n    ,A.CD_GRUPO_MATERIAL                        \n    ,A.DS_GRUPO_MATERIAL                         AS DS_GRUPO_MATERIAL\n    ,A.cd_operacao_estoque\n    ,A.DS_OPERACAO\n    ,A.QT_CONSUMO                                AS QT_MOVIMENTO\n    ,A.VL_MOVIMENTO \n    ,PF.CD_PESSOA_FISICA\n    ,PF.NM_PESSOA_FISICA\n    ,AP.NR_ATENDIMENTO      \n    ,AP.DT_ENTRADA\n    ,A.CD_CONVENIO\n    ,A.DS_CONVENIO\n    ,A.NR_MOVIMENTO_ESTOQUE\nFROM AUX A\nINNER JOIN fast_ops.ESTABELECIMENTO ESTB ON ESTB.CD_ESTABELECIMENTO = A.CD_ESTABELECIMENTO\nLEFT JOIN fast_ops.ATENDIMENTO_PACIENTE AP ON AP.NR_ATENDIMENTO = A.NR_ATENDIMENTO\nLEFT JOIN fast_ops.PESSOA_FISICA PF ON PF.CD_PESSOA_FISICA = AP.CD_PESSOA_FISICA\nLEFT JOIN fast_ops.LOCAL_ESTOQUE LE on (LE.cd_estabelecimento = A.cd_estabelecimento AND LE.cd_local_estoque = A.cd_local_estoque)\nWHERE TO_CHAR(TRUNC(A.DT_MOVIMENTO_ESTOQUE,'MM'),'YYYY-MM-DD') BETWEEN '2021-01-01' and '2022-12-01'\n",
						"partitionOption": "None",
						"queryTimeout": "02:00:00"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false,
						"tableOption": "autoCreate",
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "Tasy_Ciclo",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "AZ_SQL_SUPRIMENTOS",
						"type": "DatasetReference"
					}
				]
			},
			{
				"name": "Posicao Estoque Tasy Sadalla",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "OracleSource",
						"oracleReaderQuery": "WITH AUX AS(\n\nselect\t\n    M.NR_ATENDIMENTO,\n    m.nr_movimento_estoque,\n\tm.cd_estabelecimento,\n\tm.cd_local_estoque,\n\tm.dt_movimento_estoque,\n\tm.cd_operacao_estoque,\n\to.ds_operacao,\n\tm.cd_acao,\n\tm.cd_material_estoque,\n\tm.dt_mesano_referencia,\n\tm.dt_processo,\n\tm.cd_unidade_medida_estoque,\n\tm.cd_setor_atendimento,\n\tm.ie_origem_documento,\n\tm.nr_documento,\n\tm.nr_sequencia_item_docto,\n\tm.cd_fornecedor,\n\tm.cd_local_estoque_destino,\n\tm.cd_centro_custo,\n\tm.cd_conta_contabil,\n\tm.qt_movimento,\n\tm.cd_unidade_med_mov,\n\tm.nm_usuario,\n\tm.ds_observacao,\n\te.cd_grupo_material,\n\te.ds_grupo_material,\n\te.cd_subgrupo_material,\n\te.ds_subgrupo_material,\n\te.cd_classe_material,\n\te.ds_classe_material,\n\te.ds_material,\n\tm.nr_seq_tab_orig,\n\tobter_convenio_atendimento(m.nr_atendimento) cd_convenio,\n\tsubstr(obter_nome_convenio(obter_convenio_atendimento(m.nr_atendimento)),1,80) ds_convenio,\n\t'M' ie_periodo,\n\tdecode(\tm.cd_acao,\n\t\t2,\tm.qt_estoque * -1,\n\t\t\tm.qt_estoque) qt_estoque,\n\tdecode(\tm.cd_acao,\n\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t'N', (0))),\n\t\t1, \tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t                 'A', (v.vl_movimento),\n\t\t\t                 'D', (v.vl_movimento * -1),\n\t\t\t                 'N', (0)))) vl_estoque,\n\tdecode(m.cd_acao,\n\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t'N', (0))),\n\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t'N', (0)))) vl_movimento,\n\tdecode(o.ie_consumo,\n\t\t'A',\tdecode(m.cd_acao,\n\t\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t\t'N', (0))),\n\t\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t\t'N', (0)))),\n\t\t'D',\tdecode(m.cd_acao,\n\t\t\t2,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento * -1),\n\t\t\t\t\t'D', (v.vl_movimento),\n\t\t\t\t\t'N', (0))),\n\t\t\t1,\tsum(decode(t.ie_aumenta_diminui_valor,\n\t\t\t\t\t'A', (v.vl_movimento),\n\t\t\t\t\t'D', (v.vl_movimento * -1),\n\t\t\t\t\t'N', (0)))) *-1,\n\t0) vl_consumo,\n\tdecode(o.ie_consumo,\n\t\t'A',\tdecode(\tm.cd_acao,\n\t\t\t1,\tsum(qt_estoque),\n\t\t\t\tsum((qt_estoque * -1))),\n\t \t'D',\tdecode(\tm.cd_acao,\n\t\t\t1,\tsum(qt_estoque * -1),\n\t\t\t\tsum(qt_estoque)),\n\t\t0) qt_consumo,\n\tm.cd_material\nfrom\ttipo_valor t,\n\toperacao_estoque o,\n\testrutura_material_v e,\n\tmovimento_estoque m,\n\tmovimento_estoque_valor v\nwhere\tm.nr_movimento_estoque\t= v.nr_movimento_estoque (+)\nand\tv.cd_tipo_valor\t\t= t.cd_tipo_valor(+)\nand\tm.cd_operacao_estoque\t= o.cd_operacao_estoque (+)\nand\tm.cd_material_estoque\t= e.cd_material\nand\tm.dt_processo is not null\ngroup by\n\tm.cd_estabelecimento,\n\tm.dt_mesano_referencia,\n\tm.dt_processo,\n\tm.cd_local_estoque,\n\tm.nr_movimento_estoque,\n\tm.dt_movimento_estoque,\n\tm.cd_operacao_estoque,\n\to.ds_operacao,\n\tm.cd_acao,\n\tm.cd_material_estoque,\n\tm.cd_unidade_medida_estoque,\n\tm.cd_setor_atendimento,\n\tm.ie_origem_documento,\n\tm.nr_documento,\n\tm.nr_sequencia_item_docto,\n\tm.cd_fornecedor,\n\tm.cd_local_estoque_destino,\n\tm.cd_centro_custo,\n\tm.cd_conta_contabil,\n\tm.qt_movimento,\n\tm.cd_unidade_med_mov,\n\tm.nm_usuario,\n\tdecode(m.cd_acao, 2, m.qt_estoque * -1, m.qt_estoque),\n\tm.ds_observacao,\n\te.cd_grupo_material,\n\te.ds_grupo_material,\n\te.cd_subgrupo_material,\n\te.ds_subgrupo_material,\n\te.cd_classe_material,\n\te.ds_classe_material,\n\te.ds_material,\n\tm.nr_seq_tab_orig,\n\t'M',\n\to.ie_consumo,\n\tm.nr_atendimento,\n\tm.cd_material\n)\n\n\nSELECT \n    2   AS ID_SYS\n    ,TO_CHAR(A.DT_PROCESSO,'YYYY-MM-DD') AS DATA_PROCESSO   \n    ,A.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,A.CD_ESTABELECIMENTO\n    ,ESTB.nm_fantasia_estab                      AS DS_ESTABELECIMENTO\n    ,A.CD_MATERIAL\n    ,A.DS_MATERIAL                               AS DS_MATERIAL\n    ,A.CD_CLASSE_MATERIAL\n    ,A.DS_CLASSE_MATERIAL                        AS DS_CLASSE_MATERIAL\n    ,A.CD_GRUPO_MATERIAL                        \n    ,A.DS_GRUPO_MATERIAL                         AS DS_GRUPO_MATERIAL\n    ,A.cd_operacao_estoque\n    ,A.DS_OPERACAO\n    ,A.QT_CONSUMO                                AS QT_MOVIMENTO\n    ,A.VL_MOVIMENTO \n    ,PF.CD_PESSOA_FISICA\n    ,PF.NM_PESSOA_FISICA\n    ,AP.NR_ATENDIMENTO      \n    ,AP.DT_ENTRADA\n    ,A.CD_CONVENIO\n    ,A.DS_CONVENIO\n    ,A.NR_MOVIMENTO_ESTOQUE\nFROM AUX A\nINNER JOIN ESTABELECIMENTO ESTB ON ESTB.CD_ESTABELECIMENTO = A.CD_ESTABELECIMENTO\nLEFT JOIN ATENDIMENTO_PACIENTE AP ON AP.NR_ATENDIMENTO = A.NR_ATENDIMENTO\nLEFT JOIN PESSOA_FISICA PF ON PF.CD_PESSOA_FISICA = AP.CD_PESSOA_FISICA\nLEFT JOIN LOCAL_ESTOQUE LE on (LE.cd_estabelecimento = A.cd_estabelecimento AND LE.cd_local_estoque = A.cd_local_estoque)\nWHERE TO_CHAR(TRUNC(A.DT_MOVIMENTO_ESTOQUE,'MM'),'YYYY-MM-DD') BETWEEN '2021-01-01' and '2023-07-01'",
						"partitionOption": "None",
						"queryTimeout": "02:00:00"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false,
						"tableOption": "autoCreate",
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "AZ_TASY_SADALLA",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "AZ_SQL_SUPRIMENTOS",
						"type": "DatasetReference"
					}
				]
			}
		],
		"folder": {
			"name": "Estoque"
		},
		"annotations": []
	}
}