{
	"name": "Dado Prod",
	"properties": {
		"activities": [
			{
				"name": "PROD TASY HTML",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"sqlReaderQuery": "\nwith prod as (\n\nselect DISTINCT\n    pp.estabelecimento,\n    ap.CD_ESTABELECIMENTO,    \n    estb.NM_FANTASIA_ESTAB                                         as DS_ESTABELECIMENTO ,    \n    PP.nr_atendimento                                              as NR_ATENDIMENTO ,\n    PP.nr_interno_conta                                            as NR_INTERNO_CONTA ,\n    CONV.CD_CGC                                                    AS CGC_CONVENIO,   \n    CP.cd_convenio_parametro                                       as CD_CONVENIO ,\n    conv.ds_convenio                                               as DS_CONVENIO ,\n    ap.cd_pessoa_fisica,        \n    -- pf.nm_pessoa_fisica                                            as NM_PACIENTE ,\n    AP.dt_entrada                                                  as DT_ENTRADA ,    \n    pp.cd_medico_executor                                          AS CD_MEDICO_EXECUTANTE ,\n    ap.cd_medico_resp,\n    ap.cd_medico_atendimento,\n    pp.cd_medico_req                                               AS CD_MEDICO_SOL,\n    pp.cd_setor_atendimento,\n    sa.ds_setor_atendimento                                        as DS_SETOR_ATENDIMENTO ,\n    med_exc.nm_guerra                                              as MEDICO_EXECUTANTE, \n    med_resp.nm_guerra                                             as MEDICO_RESPONSAVEL ,\n    med_atend.nm_guerra                                            as MEDICO_ATENDIMENTO ,\n    med_req.nm_guerra                                              as MEDICO_SOLICITANTE  ,      \n    \n    CASE \n        WHEN PP.ie_tiss_tipo_guia = 7 THEN 'M' ELSE 'P' \n    END                                                            as TP_GUIA ,\n    PP.NR_SEQUENCIA,\n    cast(pp.DT_PROCEDIMENTO as date)                               as DT_LANCAMENTO, \n    PP.IE_ORIGEM_PROCED                                            AS IE_ORIGEM_PROCED,    \n    PP.cd_procedimento                                             as CD_ITEM, \n    P.ds_procedimento                                              as DS_ITEM,\n    PP.NR_SEQ_PROC_INTERNO                                         AS NR_PROC_INTERNO,         \n    PP.qt_procedimento                                             as QTD_ITEM, \n    PP.vl_medico                                                   as VL_MEDICO ,\n    PP.vl_procedimento                                             as VL_ITEM,\n    cp.IE_STATUS_ACERTO, \n    vld.DS_VALOR_DOMINIO                                           as DS_STATUS_CONTA,\n    CP.NR_SEQ_PROTOCOLO,\n    CP.nr_protocolo                                                as NR_PROTOCOLO ,\n    ap.CD_PROCEDENCIA,\n    PRC.DS_procedencia                                             as DS_PROCEDENCIA,\n    PP.DT_ATUALIZACAO,\n    estb.cd_empresa,\n    PP.NM_USUARIO\n   \n\n    \nfrom dw.tbl_procedimento_paciente          pp           with(nolock)\ninner join dw.tbl_procedimento             P            with(nolock)         on  ((pp.cd_procedimento = p.cd_procedimento)                      and (pp.ie_origem_proced = p.ie_origem_proced)) and pp.estabelecimento = p.ESTABELECIMENTO\ninner join dw.tbl_atendimento_paciente     ap           with(nolock)         on ap.nr_atendimento = pp.nr_atendimento                           and ap.ESTABELECIMENTO = pp.ESTABELECIMENTO\nleft join dw.tbl_conta_paciente            cp           with(nolock)         on cp.nr_interno_conta = pp.nr_interno_conta                       and cp.ESTABELECIMENTO = pp.ESTABELECIMENTO\ninner join dw.tbl_estabelecimento         estb          with(nolock)         on estb.cd_estabelecimento = ap.cd_estabelecimento                 AND estb.ESTABELECIMENTO = AP.ESTABELECIMENTO\ninner join dw.tbl_convenio      conv                    with(nolock)         on conv.cd_convenio = cp.cd_convenio_parametro                               AND CONV.ESTABELECIMENTO = CP.ESTABELECIMENTO\ninner join dw.tbl_setor_atendimento       sa            with(nolock)         on sa.cd_setor_atendimento = pp.cd_setor_atendimento               AND SA.ESTABELECIMENTO = PP.ESTABELECIMENTO\nleft join  dw.tbl_procedencia             prc           with(nolock)         on prc.cd_procedencia = ap.cd_procedencia                          AND PRC.ESTABELECIMENTO = AP.ESTABELECIMENTO\ninner join dw.tbl_pessoa_fisica           pf            with(nolock)         on pf.cd_pessoa_fisica = ap.cd_pessoa_fisica                       AND PF.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join dw.tbl_medico                   med_exc       with(nolock)         on med_exc.cd_pessoa_fisica = pp.cd_medico_executor                AND med_exc.ESTABELECIMENTO = PP.ESTABELECIMENTO\nleft join dw.tbl_medico                   med_resp      with(nolock)         on med_resp.cd_pessoa_fisica = ap.cd_medico_resp                   AND med_resp.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join dw.tbl_medico                   med_atend     with(nolock)         on med_atend.cd_pessoa_fisica = ap.cd_medico_atendimento           AND med_atend.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join dw.tbl_medico                   med_req       with(nolock)         on med_req.cd_pessoa_fisica = pp.cd_medico_req                     AND med_req.ESTABELECIMENTO = PP.ESTABELECIMENTO\nleft join dw.tbl_valor_dominio            vld           with(nolock)         on vld.CD_DOMINIO = 49 and vld.VL_DOMINIO = cp.IE_STATUS_ACERTO    AND VLD.ESTABELECIMENTO = CP.ESTABELECIMENTO\nOUTER APPLY(\n        SELECT TOP 1 C.CD_AREA_PROCEDIMENTO\n        FROM vw_estrutura_procedimento C\n        WHERE C.CD_PROCEDIMENTO = PP.CD_PROCEDIMENTO AND C.IE_ORIGEM_PROCED = PP.IE_ORIGEM_PROCED AND C.ESTABELECIMENTO = PP.ESTABELECIMENTO AND C.IE_SITUACAO = 'A' \n)ep\n\nwhere pp.cd_motivo_exc_conta is null\n        and CP.ie_cancelamento is null\n        and CP.nr_interno_conta is not null\n        and ep.CD_AREA_PROCEDIMENTO <> 10\n        and cp.ESTABELECIMENTO = 1\n        AND YEAR(CAST(PP.DT_PROCEDIMENTO AS DATE)) BETWEEN '2020' AND '2021'\n        -- and cp.NR_INTERNO_CONTA = 1305983\n        -- and pp.nr_atendimento = 938011 and pp.ESTABELECIMENTO = '1'\n        -- AND PP.NR_ATENDIMENTO = 6324040 AND PP.ESTABELECIMENTO = '2'\n        -- AND PP.NR_ATENDIMENTO = 6322484 AND PP.ESTABELECIMENTO = '2'\n        \n    --and obter_area_procedimento(a.cd_procedimento  a.ie_origem_proced) <> 10\n\n \n\nunion all\n\n \n\nselect \n    map.estabelecimento,\n    ap.cd_estabelecimento,\n    estb.NM_FANTASIA_ESTAB                                       as DS_ESTABELECIMENTO,    \n    map.nr_atendimento                                           as NR_ATENDIMENTO ,\n    map.nr_interno_conta                                         as NR_INTERNO_CONTA, \n    CONV.CD_CGC                                                  AS CGC_CONVENIO,   \n    cp.cd_convenio_parametro                                     as CD_CONVENIO ,\n    conv.ds_convenio                                             as DS_CONVENIO,\n    ap.cd_pessoa_fisica, \n    -- pf.nm_pessoa_fisica                                          as NM_PACIENTE ,\n     ap.dt_entrada                                               as DT_ENTRADA ,\n    0                                                            AS CD_MEDICO_EXECUTANTE,\n    ap.cd_medico_resp,\n    ap.cd_medico_atendimento,\n    0 as CD_MEDICO_SOL,\n    map.CD_SETOR_ATENDIMENTO,\n    sa.ds_setor_atendimento                                     as DS_SETOR_ATENDIMENTO, \n    med_exec.NM_GUERRA                                          as MEDICO_EXECUTANTE,    \n    med_resp.nm_guerra                                          as MEDICO_RESPONSAVEL ,\n    med_atend.nm_guerra                                         as MEDICO_ATENDIMENTO ,\n    ' '                                                         as MEDICO_REQUISITANTE ,    \n    'M'                                                         as TP_GUIA ,\n    MAP.NR_SEQUENCIA,\n    cast(map.dt_atendimento as date)                            as DT_LANCAMENTO ,\n    NULL                                                        AS IE_ORIGEM_PROCED,\n    map.cd_material                                             as CD_ITEM ,\n    mat.ds_material                                             as DS_ITEM,\n    0                                                           AS NR_PROC_INTERNO, \n    map.qt_material                                             as QT_ITEM ,\n    0                                                           as VL_MEDICO ,\n    map.vl_material                                             as VL_ITEM, \n    cp.IE_STATUS_ACERTO, \n    vld.DS_VALOR_DOMINIO                                        as DS_STATUS_CONTA,     \n    CP.NR_SEQ_PROTOCOLO,\n    cp.nr_protocolo                                             as NR_PROTOCOLO,\n    ap.CD_PROCEDENCIA, \n    PRC.DS_procedencia                                          as DS_PROCEDENCIA,\n    MAP.DT_ATUALIZACAO,\n    estb.cd_empresa,\n    MAP.NM_USUARIO\n\nfrom dw.tbl_material_atend_paciente            map          with(nolock)  \ninner join dw.tbl_atendimento_paciente         ap           with(nolock)          on ap.nr_atendimento = map.nr_atendimento                             and ap.ESTABELECIMENTO = map.ESTABELECIMENTO\nleft join dw.tbl_conta_paciente                cp           with(nolock)          on cp.nr_interno_conta = map.nr_interno_conta                         and cp.ESTABELECIMENTO = map.ESTABELECIMENTO\ninner join stg.tbl_pessoa_fisica               pf           with(nolock)          on pf.cd_pessoa_fisica = ap.cd_pessoa_fisica                          AND PF.ESTABELECIMENTO = AP.ESTABELECIMENTO\ninner join stg.tbl_convenio                    conv         with(nolock)          on conv.cd_convenio = cp.CD_CONVENIO_PARAMETRO                        AND CONV.ESTABELECIMENTO = CP.ESTABELECIMENTO\ninner join stg.tbl_setor_atendimento           sa           with(nolock)          on sa.CD_SETOR_ATENDIMENTO = map.CD_SETOR_ATENDIMENTO                 AND SA.ESTABELECIMENTO = MAP.ESTABELECIMENTO\ninner join stg.tbl_material                    mat          with(nolock)          on mat.CD_MATERIAL = map.CD_MATERIAL                                  AND MAT.ESTABELECIMENTO = MAP.ESTABELECIMENTO\nleft join stg.tbl_procedencia                  prc          with(nolock)          on prc.CD_PROCEDENCIA = ap.CD_PROCEDENCIA                             AND PRC.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join stg.tbl_medico                       med_resp     with(nolock)          on med_resp.CD_PESSOA_FISICA = ap.CD_MEDICO_RESP                      AND med_resp.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join stg.tbl_medico                       med_atend    with(nolock)          on med_atend.CD_PESSOA_FISICA = ap.CD_MEDICO_ATENDIMENTO              AND med_atend.ESTABELECIMENTO = AP.ESTABELECIMENTO\ninner join stg.tbl_estabelecimento             estb         with(nolock)          on estb.CD_ESTABELECIMENTO = ap.CD_ESTABELECIMENTO                    AND ESTB.ESTABELECIMENTO = AP.ESTABELECIMENTO\nleft join stg.tbl_valor_dominio                vld          with(nolock)          on vld.CD_DOMINIO = 49 and vld.VL_DOMINIO = cp.IE_STATUS_ACERTO       AND VLD.ESTABELECIMENTO = CP.ESTABELECIMENTO\nouter apply (\n            select top 1 med.nm_guerra \n                        from DW.tbl_cirurgia x\n                        inner join DW.tbl_medico med on med.cd_pessoa_fisica = x.cd_medico_cirurgiao and med.ESTABELECIMENTO = x.ESTABELECIMENTO\n                where x.nr_cirurgia = map.nr_cirurgia and x.ESTABELECIMENTO = map.ESTABELECIMENTO\n)med_exec\n\n\nwhere map.cd_motivo_exc_conta is null\nand cp.ie_cancelamento is null\nand cp.nr_interno_conta is not null\nand cp.estabelecimento = 1\nAND YEAR(CAST(MAP.DT_CONTA AS DATE)) BETWEEN '2020' AND '2021'\n-- and cp.nr_interno_conta = 1305983\n-- and map.nr_atendimento = 938011 and map.ESTABELECIMENTO = '1'\n-- AND MAP.NR_ATENDIMENTO = 6324040 AND MAP.ESTABELECIMENTO = '2'\n-- AND MAP.NR_ATENDIMENTO = 6322484 AND MAP.ESTABELECIMENTO = '2'\n\n)\n\nselect \nEMP.DS_NOME_CURTO       AS DS_MARCA\n,A.*\n,PC.DT_PERIODO_INICIAL\n,PC.DT_ENVIO                                                   as DT_INICIO_PRE_FAT\n,ISNULL(NF.DT_EMISSAO,PC.DT_MESANO_REFERENCIA)                 AS DT_EMISSAO_NF\nfrom prod A\ninner join dw.tbl_empresa emp on emp.cd_empresa = a.cd_empresa AND emp.ESTABELECIMENTO = a.ESTABELECIMENTO\nleft join dw.TBL_PROTOCOLO_CONVENIO pc on PC.NR_SEQ_PROTOCOLO = A.NR_SEQ_PROTOCOLO and PC.ESTABELECIMENTO = A.ESTABELECIMENTO\nOUTER APPLY(\n    SELECT\n            Z.NR_NOTA_FISCAL\n            ,Z.NR_INTERNO_CONTA\n            ,MAX(Z.DT_EMISSAO) DT_EMISSAO\n            ,MAX(Z.NR_SEQUENCIA) NR_SEQ\n    FROM DW.TBL_NOTA_FISCAL Z\n    WHERE Z.nr_interno_conta = A.NR_INTERNO_CONTA\n    GROUP BY \n            Z.NR_NOTA_FISCAL\n            ,Z.NR_INTERNO_CONTA\n            ,Z.DT_EMISSAO\n)NF",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "DelimitedTextSink",
						"storeSettings": {
							"type": "FileServerWriteSettings"
						},
						"formatSettings": {
							"type": "DelimitedTextWriteSettings",
							"quoteAllText": true,
							"fileExtension": ".txt"
						}
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "Prod_Tasy_HTML",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "CSV_AM_PROD",
						"type": "DatasetReference"
					}
				]
			}
		],
		"folder": {
			"name": "A&M"
		},
		"annotations": []
	}
}