{
	"name": "Posicao_estoque DB",
	"properties": {
		"activities": [
			{
				"name": "Tasy HTML",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "OracleSource",
						"oracleReaderQuery": "/*WITH AUX AS(\nselect \n       b.CD_ESTABELECIMENTO, \n       a.cd_material,\n       obter_desc_material(a.cd_material) ds_material,\n       A.cd_cgc_fornec,\n       obter_nome_pf_pj('',a.cd_cgc_fornec) ds_razao_social,\n      b.dt_mesano_referencia,\n       a.dt_validade,       \n       a.nr_sequencia,\n       a.ds_lote_fornec,    \n       obter_saldo_lote_fornec(a.nr_sequencia) qt_saldo_lote,\n       a.ds_observacao\n  FROM MATERIAL_LOTE_FORNEC A    \n  LEFT JOIN SALDO_ESTOQUE_LOTE B ON A.NR_SEQUENCIA = B.NR_SEQ_LOTE\n  INNER JOIN ESTRUTURA_MATERIAL_V C ON B.CD_MATERIAL = C.CD_MATERIAL\n     \n where b.qt_estoque > 0\n   --AND b.dt_mesano_referencia = trunc(sysdate,'MM')\n   -- AND b.dt_mesano_referencia = '01/06/2021'\n\n--   AND B.CD_MATERIAL = 36882\n)\n*/\n\nSELECT\n    SE.DT_MESANO_REFERENCIA\n    ,ESTB.NM_FANTASIA_ESTAB                        AS DS_ESTABELECIMENTO\n    ,SE.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,SE.CD_MATERIAL\n    ,MAT.DS_MATERIAL                            AS DS_MATERIAL\n    ,MAT_G.CD_GRUPO_MATERIAL\n    ,MAT_G.DS_GRUPO_MATERIAL\n    ,MAT_C.CD_CLASSE_MATERIAL\n    ,MAT_C.DS_CLASSE_MATERIAL\n--    ,X.DS_LOTE_FORNEC\n--    ,x.cd_cgc_fornec\n--    ,x.DS_RAZAO_SOCIAL\n--    ,TO_CHAR(X.DT_VALIDADE,'DD/MM/YYYY')        AS DT_VALIDADE\n    ,SUM(SE.QT_ESTOQUE)                          AS QT_ESTOQUE\n    ,SUM(SE.QT_ESTOQUE * SE.VL_CUSTO_MEDIO)      AS VL_ESTOQUE\n    ,SE.VL_CUSTO_MEDIO\n    ,SE.VL_PRECO_ULT_COMPRA\n    ,SE.dt_ult_compra\nFROM SALDO_ESTOQUE SE\n\nINNER JOIN LOCAL_ESTOQUE LE                                                 ON LE.CD_LOCAL_ESTOQUE = SE.CD_LOCAL_ESTOQUE\nLEFT JOIN ESTABELECIMENTO ESTB                                              ON ESTB.CD_ESTABELECIMENTO = SE.CD_ESTABELECIMENTO\nINNER JOIN MATERIAL MAT                                                     ON MAT.CD_MATERIAL = SE.CD_MATERIAL\nLEFT JOIN CLASSE_MATERIAL MAT_C                                             ON MAT_C.CD_CLASSE_MATERIAL = MAT.CD_CLASSE_MATERIAL\nLEFT JOIN SUBGRUPO_MATERIAL MAT_S                                           ON MAT_S.CD_SUBGRUPO_MATERIAL = MAT_C.CD_SUBGRUPO_MATERIAL\nLEFT JOIN GRUPO_MATERIAL    MAT_G                                           ON MAT_G.CD_GRUPO_MATERIAL = MAT_S.CD_GRUPO_MATERIAL\n/*OUTER APPLY(\n    SELECT B.* \n    FROM AUX B\n    WHERE SE.CD_MATERIAL = B.CD_MATERIAL  AND SE.DT_MESANO_REFERENCIA = B.DT_MESANO_REFERENCIA AND B.CD_ESTABELECIMENTO = SE.CD_ESTABELECIMENTO\n        AND ROWNUM = 1\n)X*/\nWHERE TO_CHAR(SE.DT_MESANO_REFERENCIA,'YYYY-MM-DD') between '2021-01-01' and '2021-09-01'\n    --AND SE.CD_MATERIAL = 83971\n\nGROUP BY\n    SE.DT_MESANO_REFERENCIA\n    ,ESTB.NM_FANTASIA_ESTAB\n    ,SE.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,SE.CD_MATERIAL\n    ,MAT.DS_MATERIAL \n    ,MAT_G.CD_GRUPO_MATERIAL\n    ,MAT_G.DS_GRUPO_MATERIAL\n    ,MAT_C.CD_CLASSE_MATERIAL\n    ,MAT_C.DS_CLASSE_MATERIAL    \n--    ,X.DS_LOTE_FORNEC\n--    ,X.cd_cgc_fornec\n--    ,X.DS_RAZAO_SOCIAL\n--    ,TO_CHAR(X.DT_VALIDADE,'DD/MM/YYYY')\n    ,SE.VL_CUSTO_MEDIO\n    ,SE.VL_PRECO_ULT_COMPRA\n    ,SE.dt_ult_compra",
						"partitionOption": "None",
						"queryTimeout": "02:00:00"
					},
					"sink": {
						"type": "DelimitedTextSink",
						"storeSettings": {
							"type": "FileServerWriteSettings"
						},
						"formatSettings": {
							"type": "DelimitedTextWriteSettings",
							"quoteAllText": true,
							"fileExtension": ".txt"
						}
					},
					"enableStaging": false
				},
				"inputs": [
					{
						"referenceName": "CloudTasyPrdDataSet",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "CSV_Estoque_Saldo_Tasy_HTML",
						"type": "DatasetReference"
					}
				]
			},
			{
				"name": "Tasy Delphi CSV",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "OracleSource",
						"oracleReaderQuery": "/*WITH AUX AS(\nselect \n       b.CD_ESTABELECIMENTO, \n       a.cd_material,\n       obter_desc_material(a.cd_material) ds_material,\n       A.cd_cgc_fornec,\n       obter_nome_pf_pj('',a.cd_cgc_fornec) ds_razao_social,\n      b.dt_mesano_referencia,\n       a.dt_validade,       \n       a.nr_sequencia,\n       a.ds_lote_fornec,    \n       obter_saldo_lote_fornec(a.nr_sequencia) qt_saldo_lote,\n       a.ds_observacao\n  FROM MATERIAL_LOTE_FORNEC A    \n  LEFT JOIN SALDO_ESTOQUE_LOTE B ON A.NR_SEQUENCIA = B.NR_SEQ_LOTE\n  INNER JOIN ESTRUTURA_MATERIAL_V C ON B.CD_MATERIAL = C.CD_MATERIAL\n     \n where b.qt_estoque > 0\n   --AND b.dt_mesano_referencia = trunc(sysdate,'MM')\n   -- AND b.dt_mesano_referencia = '01/06/2021'\n\n--   AND B.CD_MATERIAL = 36882\n)\n*/\n\nSELECT\n    SE.DT_MESANO_REFERENCIA\n    ,ESTB.NM_FANTASIA_ESTAB                        AS DS_ESTABELECIMENTO\n    ,SE.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,SE.CD_MATERIAL\n    ,MAT.DS_MATERIAL                            AS DS_MATERIAL\n    ,MAT_G.CD_GRUPO_MATERIAL\n    ,MAT_G.DS_GRUPO_MATERIAL\n    ,MAT_C.CD_CLASSE_MATERIAL\n    ,MAT_C.DS_CLASSE_MATERIAL\n--    ,X.DS_LOTE_FORNEC\n--    ,x.cd_cgc_fornec\n--    ,x.DS_RAZAO_SOCIAL\n--    ,TO_CHAR(X.DT_VALIDADE,'DD/MM/YYYY')        AS DT_VALIDADE\n    ,SUM(SE.QT_ESTOQUE)                          AS QT_ESTOQUE\n    ,SUM(SE.QT_ESTOQUE * SE.VL_CUSTO_MEDIO)      AS VL_ESTOQUE\n    ,SE.VL_CUSTO_MEDIO\n    ,SE.VL_PRECO_ULT_COMPRA\n    ,SE.dt_ult_compra\nFROM SALDO_ESTOQUE SE\n\nINNER JOIN LOCAL_ESTOQUE LE                                                 ON LE.CD_LOCAL_ESTOQUE = SE.CD_LOCAL_ESTOQUE\nLEFT JOIN ESTABELECIMENTO ESTB                                              ON ESTB.CD_ESTABELECIMENTO = SE.CD_ESTABELECIMENTO\nINNER JOIN MATERIAL MAT                                                     ON MAT.CD_MATERIAL = SE.CD_MATERIAL\nLEFT JOIN CLASSE_MATERIAL MAT_C                                             ON MAT_C.CD_CLASSE_MATERIAL = MAT.CD_CLASSE_MATERIAL\nLEFT JOIN SUBGRUPO_MATERIAL MAT_S                                           ON MAT_S.CD_SUBGRUPO_MATERIAL = MAT_C.CD_SUBGRUPO_MATERIAL\nLEFT JOIN GRUPO_MATERIAL    MAT_G                                           ON MAT_G.CD_GRUPO_MATERIAL = MAT_S.CD_GRUPO_MATERIAL\n/*OUTER APPLY(\n    SELECT B.* \n    FROM AUX B\n    WHERE SE.CD_MATERIAL = B.CD_MATERIAL  AND SE.DT_MESANO_REFERENCIA = B.DT_MESANO_REFERENCIA AND B.CD_ESTABELECIMENTO = SE.CD_ESTABELECIMENTO\n        AND ROWNUM = 1\n)X*/\nWHERE TO_CHAR(SE.DT_MESANO_REFERENCIA,'YYYY-MM-DD') between '2021-01-01' and '2021-09-01'\n    --AND SE.CD_MATERIAL = 83971\n\nGROUP BY\n    SE.DT_MESANO_REFERENCIA\n    ,ESTB.NM_FANTASIA_ESTAB\n    ,SE.CD_LOCAL_ESTOQUE\n    ,LE.DS_LOCAL_ESTOQUE\n    ,SE.CD_MATERIAL\n    ,MAT.DS_MATERIAL \n    ,MAT_G.CD_GRUPO_MATERIAL\n    ,MAT_G.DS_GRUPO_MATERIAL\n    ,MAT_C.CD_CLASSE_MATERIAL\n    ,MAT_C.DS_CLASSE_MATERIAL    \n--    ,X.DS_LOTE_FORNEC\n--    ,X.cd_cgc_fornec\n--    ,X.DS_RAZAO_SOCIAL\n--    ,TO_CHAR(X.DT_VALIDADE,'DD/MM/YYYY')\n    ,SE.VL_CUSTO_MEDIO\n    ,SE.VL_PRECO_ULT_COMPRA\n    ,SE.dt_ult_compra",
						"partitionOption": "None",
						"queryTimeout": "02:00:00"
					},
					"sink": {
						"type": "DelimitedTextSink",
						"storeSettings": {
							"type": "FileServerWriteSettings"
						},
						"formatSettings": {
							"type": "DelimitedTextWriteSettings",
							"quoteAllText": true,
							"fileExtension": ".txt"
						}
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"mappings": [
							{
								"source": {
									"name": "DT_MESANO_REFERENCIA"
								},
								"sink": {
									"name": "DT_MESANO_REFERENCIA",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DS_ESTABELECIMENTO"
								},
								"sink": {
									"name": "DS_ESTABELECIMENTO",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "CD_LOCAL_ESTOQUE"
								},
								"sink": {
									"name": "CD_LOCAL_ESTOQUE",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DS_LOCAL_ESTOQUE"
								},
								"sink": {
									"name": "DS_LOCAL_ESTOQUE",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "CD_MATERIAL"
								},
								"sink": {
									"name": "CD_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DS_MATERIAL"
								},
								"sink": {
									"name": "DS_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "CD_GRUPO_MATERIAL"
								},
								"sink": {
									"name": "CD_GRUPO_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DS_GRUPO_MATERIAL"
								},
								"sink": {
									"name": "DS_GRUPO_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "CD_CLASSE_MATERIAL"
								},
								"sink": {
									"name": "CD_CLASSE_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DS_CLASSE_MATERIAL"
								},
								"sink": {
									"name": "DS_CLASSE_MATERIAL",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "QT_ESTOQUE"
								},
								"sink": {
									"name": "QT_ESTOQUE",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "VL_ESTOQUE"
								},
								"sink": {
									"name": "VL_ESTOQUE",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "VL_CUSTO_MEDIO"
								},
								"sink": {
									"name": "VL_CUSTO_MEDIO",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "VL_PRECO_ULT_COMPRA"
								},
								"sink": {
									"name": "VL_PRECO_ULT_COMPRA",
									"type": "String"
								}
							},
							{
								"source": {
									"name": "DT_ULT_COMPRA"
								},
								"sink": {
									"name": "DT_ULT_COMPRA",
									"type": "String"
								}
							}
						]
					}
				},
				"inputs": [
					{
						"referenceName": "SadallaTasyPrdDataSet",
						"type": "DatasetReference"
					}
				],
				"outputs": [
					{
						"referenceName": "CSV_Estoque_Saldo_Tasy_DELPHI",
						"type": "DatasetReference"
					}
				]
			}
		],
		"folder": {
			"name": "Estoque"
		},
		"annotations": []
	}
}